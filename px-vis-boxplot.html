<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../px-vis/px-vis-scale.html">
<link rel="import" href="../px-vis/px-vis-svg.html">
<link rel="import" href="../px-vis/px-vis-bar-svg.html">
<link rel="import" href="../px-vis/px-vis-axis.html">
<link rel="import" href="../px-vis/px-vis-line-svg.html">
<link rel="import" href="px-vis-box-whisker.html">

<link rel="import" href="../px-vis/px-vis-behavior-colors.html">
<link rel="import" href="../px-vis/px-vis-behavior-common.html">
<link rel="import" href="../px-vis/px-vis-behavior-chart.html">


<dom-module id="px-vis-boxplot">
  <template>
    <button on-click="_add">Add</button>
    <button on-click="_remove">Remove</button>
    <button on-click="_update">Update</button>
    <px-vis-svg
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      svg="{{svg}}">
    </px-vis-svg>
    <px-vis-scale
      x-axis-type="linear"
      y-axis-type="linear"
      complete-series-config="[[completeSeriesConfig]]"
      chart-extents="[[chartExtents]]"
      data-extents="[[dataExtents]]"
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      chart-data="[[_returnEmptyChartData(dataset)]]"
      x="{{x}}"
      y="{{y}}"
      domain-changed="{{domainChanged}}">
    </px-vis-scale>
    <!-- y axis -->
    <px-vis-axis
      svg="[[svg]]"
      axis="[[y]]"
      margin="[[margin]]"
      width="[[width]]"
      height="[[height]]"
      title="Y Axis"
      orientation="left"
      label-position="center"
      complete-series-config="[[completeSeriesConfig]]"
      muted-series=[[mutedSeries]]
      domain-changed="[[domainChanged]]">
    </px-vis-axis>
    <!-- x axis -->
    <px-vis-axis
      svg="[[svg]]"
      axis="[[x]]"
      margin="[[margin]]"
      width="[[width]]"
      height="[[height]]"
      title="X Axis"
      orientation="bottom"
      label-position="center"
      complete-series-config="[[completeSeriesConfig]]"
      muted-series=[[mutedSeries]]
      domain-changed="[[domainChanged]]">
    </px-vis-axis>
    <!-- box and whisker components -->
    <template is="dom-repeat" items="[[chartData]]" restamp>
      <px-vis-box-whisker
        data="[[item.data]]"
        position="[[item.position]]"
        svg="[[svg]]"
        x="[[x]]"
        y="[[y]]"
        domain-changed="[[domainChanged]]"
        box-width="[[boxWhiskerConfig.boxWidth]]"
        edge-width="[[boxWhiskerConfig.edgeWidth]]"
        fill-color="[[boxWhiskerConfig.fillColor]]"
        stroke-color="[[boxWhiskerConfig.strokeColor]]"
        median-stroke-color="[[boxWhiskerConfig.medianStrokeColor]]"
        mean-radius="[[boxWhiskerConfig.meanRadius]]"
        mean-fill-color="[[boxWhiskerConfig.meanFillColor]]"
        outlier-radius="[[boxWhiskerConfig.outlierRadius]]"
        outlier-fill-color="[[boxWhiskerConfig.outlierFillColor]]">
      </px-vis-box-whisker>
    </template>

  </template>
  <script>
    Polymer({

      is: 'px-vis-boxplot',

      behaviors: [
        PxColorsBehavior.dataVisColors,
        PxColorsBehavior.dataVisColorTheming,
        PxColorsBehavior.getSeriesColors,
        PxVisBehavior.baseSize,
        PxVisBehavior.margins,
        PxVisBehavior.observerCheck,
        PxVisBehaviorChart.subConfiguration
      ],

      properties: {

        /**
         * An array of objects that contain data for each box and whisker
         * component on the box plot chart.
         *
         * ```
         * [{
         *   position: 1,
         *   data: {
         *     max: 90,
         *     q3: 70,
         *     mean: 50,
         *     median: 50,
         *     q1: 30,
         *     min: 10,
         *     outliers: [5, 2]
         *   }
         * }]
         * ```
         */
        chartData: {
          type: Array,
          value: [],
          notify: true
        },

        width: {
          type: Number,
          value: 500
        },

        height: {
          type: Number,
          value: 200
        },

        margin: {
          type: Object,
          value: function() {
            return {
              'top': 10,
              'right': 10,
              'bottom': 50,
              'left': 50
            };
          }
        },

        /**
         * Configuration object used to configure the box and whisker
         * components.  Refer to px-vis-box-whisker.html for a list
         * of valid properties.
         */
        boxWhiskerConfig: {
          type: Object
        },

        dataExtents: {
          type: Object,
          value: function() {
            return {
              x: [0, 10],
              y: [0, 100],
            };
          }
        },

        dataset: {
          type: String,
          value: 'single'
        },

        domainChanged: {
          type: Boolean
        },

        completeSeriesConfig: {
          type: Object
        },

        _colorsAreSet: {
          type: Boolean,
          value: false
        },

        /**
         * Some of px components require raw chart data to work properly.
         * We use this in order to simply satisfy the existance of 'chart data'.
         */
        _emptyChartData: {
          type: Array,
          value: function() {
            return [{
              'x': 0,
              'y': 0
            }];
          }
        }

      },

      observers: [
        '_chartDataChanged(chartData, chartData.*)',
        '_boxWhiskerConfigChanged(boxWhiskerConfig)',
        '_updateSeriesConfig(_colorsAreSet)'
      ],

      listeners: {
        'px-data-vis-colors-applied': '_colorsSet'
      },

      ready: function() {
        window.chart = this;
      },

      // TODO: REMOVE
      _add: function() {
        this.push('chartData', {
          position: this.chartData.length + 1,
          data: this._rawDataToBoxplotData()
        });
      },

      // TODO: REMOVE
      _remove: function() {
        if (this.chartData.length > 0) {
          this.splice('chartData', this.chartData.length - 1, 1);
        }
      },

      // TODO: REMOVE
      _update: function() {
        const boxWhiskers = this.shadowRoot.querySelectorAll('px-vis-box-whisker');
        boxWhiskers.forEach((drawing) => {
          drawing.data = this._rawDataToBoxplotData();
        });
      },

      /**
       * Takes array of data points and calculates values required to build
       * a boxplot diagram such as the quartiles, median, etc..
       */
      _rawDataToBoxplotData: function(rawData) {
        // TODO: implement data conversion/calc logic
        return {
          max: 90 + Math.random() * 10,
          q3: 70 + Math.random() * 10,
          mean: 50 + Math.random() * 10,
          median: 50 + Math.random() * 10,
          q1: 30 + Math.random() * 10,
          min: 10 + Math.random() * 10,
          outliers: [0 + Math.random() * 5, 5 + Math.random() * 5]
        };
      },

      /**
      * Returns data array with a single point (x0,y0).
      */
      _returnEmptyChartData: function() {
        return this._emptyChartData;
      },

      _chartDataChanged: function(chartData) {
        if (!chartData || chartData.length < 1) {
          return;
        }
        this.dataExtents = this._calcDataExtents(chartData);
      },

      _calcDataExtents: function(chartData) {
        if (!chartData) {
          console.warn('Cannot update data extents as chartData is null');
          return;
        }
        const exts = {};
        exts.x = [0, chartData.length + 1];
        exts.y = [Number.MAX_SAFE_INTEGER, Number.MIN_SAFE_INTEGER];
        // to find the min/max y values, we need to check each set of data
        for (const i in chartData) {
          const data = chartData[i].data;
          const outliersMin = Math.min.apply(Math, data.outliers);
          const outliersMax = Math.max.apply(Math, data.outliers);
          // compare current min/max, current series min/max, and the min/max of outliers
          exts.y = [
            Math.min(exts.y[0], data.min, outliersMin),
            Math.max(exts.y[1], data.max, outliersMax)
          ];
        }
        return exts;
      },

      /**
       * Apply changes to config object to the children components.
       */
      _boxWhiskerConfigChanged: function(conf) {
        if (this.hasUndefinedArguments(arguments)) {
          return;
        }
        const comps = this.shadowRoot.querySelectorAll('px-vis-box-whisker');
        if (comps) {
          comps.forEach(function(comp) {
            this._applyConfigToElement(this.boxWhiskerConfig, comp);
          }.bind(this));
        }
      },

      _updateSeriesConfig: function() {
        this.debounce('_updateSeriesConfig', function() {
          if (this._colorsAreSet) {
            this.set('completeSeriesConfig', {
              'mySeries': {
                'name': 'My-Series',
                'x': 'x',
                'y': 'y',
                'color': this._getColor(0)
              }
            });
          }
        }, 10);
      },

      _colorsSet: function() {
        this.set('_colorsAreSet', true);
      }

    });
  </script>
</dom-module>
