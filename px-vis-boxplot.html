<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../px-vis/px-vis-scale.html">
<link rel="import" href="../px-vis/px-vis-svg.html">
<link rel="import" href="../px-vis/px-vis-bar-svg.html">
<link rel="import" href="../px-vis/px-vis-axis.html">
<link rel="import" href="../px-vis/px-vis-line-svg.html">

<link rel="import" href="../px-vis/px-vis-behavior-colors.html">
<link rel="import" href="../px-vis/px-vis-behavior-common.html">


<dom-module id="px-vis-boxplot">
  <template>
    <px-vis-svg
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      svg="{{svg}}">
    </px-vis-svg>
    <px-vis-scale
      x-axis-type="linear"
      y-axis-type="linear"
      complete-series-config="[[seriesConfig]]"
      chart-extents="[[chartExtents]]"
      data-extents="[[dataExtents]]"
      width="[[width]]"
      height="[[height]]"
      margin="[[margin]]"
      chart-data="[[_returnEmptyChartData(dataset)]]"
      x="{{x}}"
      y="{{y}}"
      domain-changed="{{domainChanged}}">
    </px-vis-scale>
    <!-- y axis -->
    <px-vis-axis
      svg="[[svg]]"
      axis="[[y]]"
      margin="[[margin]]"
      width="[[width]]"
      height="[[height]]"
      title="Y Axis"
      orientation="left"
      label-position="center"
      complete-series-config="[[seriesConfig]]"
      muted-series=[[mutedSeries]]
      domain-changed="[[domainChanged]]">
    </px-vis-axis>
    <!-- x axis -->
    <px-vis-axis
      svg="[[svg]]"
      axis="[[x]]"
      margin="[[margin]]"
      width="[[width]]"
      height="[[height]]"
      title="X Axis"
      orientation="bottom"
      label-position="center"
      complete-series-config="[[seriesConfig]]"
      muted-series=[[mutedSeries]]
      domain-changed="[[domainChanged]]">
    </px-vis-axis>
  </template>
  <script>
    Polymer({

      is: 'px-vis-boxplot',

      behaviors: [
        PxColorsBehavior.dataVisColors,
        PxColorsBehavior.dataVisColorTheming,
        PxColorsBehavior.getSeriesColors
      ],

      properties: {

        width: {
          type: Number,
          value: 500
        },

        height: {
          type: Number,
          value: 200
        },

        margin: {
          type: Object,
          value: function() {
            return {
              'top': 10,
              'right': 10,
              'bottom': 50,
              'left': 50
            };
          }
        },

        /**
         * Some of px components require raw chart data to work properly.
         * We use this in order to simply satisfy the existance of 'chart data'.
         */
        _emptyChartData: {
          type: Array,
          value: function() {
            return [{
              'x': 0,
              'y': 0
            }];
          }
        },

        /**
         * Max and min values for x and y axis.
         */
        chartExtents: {
          type: Object,
          value: function() {
            return {
              x: [0, 10],
              y: [0, 100],
            };
          }
        },

        dataExtents: {
          type: Object,
          value: {}
        },

        dataset: {
          type: String,
          value: 'single'
        },

        domainChanged: {
          type: Boolean
        },

        seriesConfig: {
          type: Object
        },

        _colorsAreSet: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_updateSeriesConfig(_colorsAreSet)'
      ],

      listeners: {
        'px-data-vis-colors-applied': '_colorsSet'
      },

      /**
       * TODO: remove this
       * Dev function that draws several plotbox components.
       */
      drawAll: function() {
        const datasets = [
          this._rawDataToBoxplotData(),
          this._rawDataToBoxplotData(),
          this._rawDataToBoxplotData()
        ];
        let i = 1;
        datasets.forEach(data => this.drawPlotbox(data, i++));
      },

      /**
       * TODO: move to separate BoxAndWhisker component.
       * Draw plotbox diagram.
       */
      drawPlotbox: function(plotData, xPos) {
        // load example data
        if (!plotData) {
          return;
        }
        // get svg coordinates for our boxplot values
        const points = this._chartDataToSvgPoints(plotData, xPos);
        // width of boxplot drawing
        const width = 30;
        // get the left offset
        const left = this.x(xPos) - (width / 2);
        const right = left + width;
        const middle = width / 2 + left;
        // top line
        this.svg.append('path')
          .attr('d', 'M ' + left + ' ' + points.max + ' H' + right)
          .attr('stroke', 'black');
        // q1 whisker
        this.svg.append('path')
          .attr('d', 'M ' + middle + ' ' + points.max + ' V' + points.q3)
          .attr('stroke', 'black');
        // q3 box
        this.svg.append('path')
          .attr('d', 'M ' + left + ' ' + points.q3 + ' H' + right + ' V' + points.median
            + ' H ' + left + ' V' + points.q3)
          .attr('fill', 'transparent').attr('stroke', 'black');
        // q1 box
        this.svg.append('path')
          .attr('d', 'M ' + left + ' ' + points.q1 + ' H' + right + ' V' + points.median
            + ' H ' + left + ' V' + points.q1)
          .attr('fill', 'transparent').attr('stroke', 'black');
        // median line
        this.svg.append('path')
          .attr('d', 'M ' + left + ' ' + points.median + ' H' + right)
          .attr('stroke', 'black');
        // q3 whisker
        this.svg.append('path')
          .attr('d', 'M ' + middle + ' ' + points.min + 'V' + points.q1)
          .attr('stroke', 'black');
        // bottom line
        this.svg.append('path')
          .attr('d', 'M ' + left + ' ' + points.min + ' H' + right)
          .attr('stroke', 'black');

        `<g>
          <!-- top line -->
          <path stroke="green" d="M 0 10 H30 " />
          <!-- q3 wisker -->
          <path stroke="orange" d="M 15 10 V30 " />
          <!-- q3 box -->
          <path stroke="orange" fill="transparent" d="M 0 30 H30 V50 H0 V30" />
          <!-- q1 box -->
          <path stroke="red" fill="transparent" d="M 0 70 H30 V50 H0 V70" />
          <!-- median -->
          <path stroke="blue" d="M 0 50 H30" />
          <!-- q1 wisker -->
          <path stroke="red" d="M 15 90 V70 " />
          <!-- bottom line -->
          <path stroke="green" d="M 0 90 H30 " />
        </g>`;
      },

      /**
       * Takes array of data points and calculates values required to build
       * a boxplot diagram such as the quartiles, median, etc..
       */
      _rawDataToBoxplotData: function(rawData) {
        // TODO: implement data conversion/calc logic
        return {
          max: 90 + Math.random() * 10,
          q3: 70 + Math.random() * 10,
          median: 50 + Math.random() * 10,
          q1: 30 + Math.random() * 10,
          min: 10 + Math.random() * 10
        };
      },

      /**
       * Returns copy of data object but with values converted
       * to svg positions based on the px scale.
       */
      _chartDataToSvgPoints: function(data) {
        const formatted = {};
        for (const key in data) {
          formatted[key] = this.y(data[key]);
        }
        return formatted;
      },

      _colorsSet: function() {
        this.set('_colorsAreSet', true);
      },

      /**
      * Returns data array with a single point (x0,y0).
      */
      _returnEmptyChartData: function() {
        return this._emptyChartData;
      },

      _updateSeriesConfig: function() {
        this.debounce('_updateSeriesConfig', function() {
          if (this._colorsAreSet) {
            this.set('seriesConfig', {
              'mySeries': {
                'name': 'My-Series',
                'x': 'x',
                'y': 'y',
                'color': this._getColor(0)
              }
            });
          }
        }, 10);
      }

    });
  </script>
</dom-module>
